<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.11.1/dist/cdn.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <style>
    /*
      1. Use a more-intuitive box-sizing model.
    */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    /*
      2. Remove default margin
    */
    * {
      margin: 0;
    }
    /*
      3. Allow percentage-based heights in the application
    */
    html, body {
      height: 100%;
    }
    /*
      Typographic tweaks!
      4. Add accessible line-height
      5. Improve text rendering
    */
    body {
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    /*
      6. Improve media defaults
    */
    img, picture, video, canvas, svg {
      display: block;
      max-width: 100%;
    }
    /*
      7. Remove built-in form typography styles
    */
    input, button, textarea, select {
      font: inherit;
    }
    /*
      8. Avoid text overflows
    */
    p, h1, h2, h3, h4, h5, h6 {
      overflow-wrap: break-word;
    }

    .dropdowns {
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .dropdowns > * {
      width: 100%;
      height: 46px;
      margin-block-end: 0;
    }

    @media screen and (min-width: 768px) {
      .dropdowns {
        flex-direction: row;
      }

      .dropdowns > * {
        min-width: 500px;
      }
    }
  </style>

  <script>
    let handleize = (str) => str.toLowerCase().replace(/ /g, '-');
    let country;

    async function checkUserLocation() {
      let usersCountry = sessionStorage.getItem("usersCountry");

      if (usersCountry === null) {
        usersCountry = await fetch("https://get.geojs.io/v1/ip/country.json")
          .then((response) => response.json())
          .then((code) => {
            sessionStorage.setItem("usersCountry", code.name);

            return usersCountry;
          })
          .catch((err) => console.error(err));
      }

      country = usersCountry;
    }

    document.addEventListener('DOMContentLoaded', () => {
      checkUserLocation();
    })

    document.addEventListener('alpine:init', () => {
      let sheet;
      const countries = [];
      const cities = [];

      Alpine.data('dropdowns', () => ({
        country: null,
        city: null,
        date: null,
        citiesIsDisabled: true,
        datesIsDisabled: true,
        optionsCountries: [],
        optionsCities: [],
        optionsDates: [],
        init() {
          this.$nextTick(async () => {
            let url = 'https://api.sheety.co/654ba0af3567b546e1dc142300c1e3d4/beautyAndTheBeast/sheet1';
            sheet = await fetch(url)
              .then((response) => response.json())
              .then((json) => json.sheet1);

            // Extract location & event date from our Google Sheet
            sheet.forEach((item) => {
              // console.log('ðŸš€ ~ sheet.forEach ~ item', item);
              const country   = handleize(item.country);
              const city      = handleize(item.city);

              if (countries[country] === undefined) {
                countries[country] = []
              }

              if (cities[city] === undefined) {
                cities[city] = []
              }

              countries[country].push(item)
              cities[city].push({
                id: item.id,
                date: item.date,
              })
            })

            // Initiate Choices selects
            let choicesCities = new Choices(this.$refs.cities);
            let choicesCountries = new Choices(this.$refs.countries);
            let choicesDates = new Choices(this.$refs.dates);

            // Build city options according to selected country
            const setCities = (country) => {
              this.optionsCities = [];

              for (const [key, value] of Object.entries(countries[country])) {
                const city = handleize(value.city);
                const option = {
                  value: city,
                  label: value.city
                }

                this.optionsCities.push(option);
              }

              this.optionsCities = this.optionsCities.filter((a, i) => this.optionsCities.findIndex((s) => a.label === s.label) === i)

              choicesCities.clearStore();
              choicesCities.setChoices(this.optionsCities);
            }

            // Build date options according to selected city
            const setDates = (city) => {
              this.optionsDates = [];

              for (const [key, value] of Object.entries(cities[city])) {
                const date = handleize(value.date);
                const option = {
                  value: date,
                  label: value.date
                }

                this.optionsDates.push(option);
              }

              this.optionsDates = this.optionsDates.filter((a, i) => this.optionsDates.findIndex((s) => a.label === s.label) === i)

              choicesDates.clearStore();
              choicesDates.setChoices(this.optionsDates);
            }

            // Build country list & set option values
            for (const [key, value] of Object.entries(countries)) {
              this.optionsCountries.push({
                value: key,
                label: value[0].country,
                selected: value[0].country == country || value[0].country == this.value
              });
            }

            // Set country options
            choicesCountries.setChoices(this.optionsCountries);

            // Add event listeners
            this.$refs.countries.addEventListener('change', () => {
              const country = choicesCountries.getValue(true);

              this.country = country;
              this.citiesIsDisabled = country === '';
            })

            this.$refs.cities.addEventListener('change', () => {
              const city = choicesCities.getValue(true);

              this.city = city;
              this.citiesIsDisabled = city === '';
            })

            // Add watchers
            this.$watch('country', () => {
              const country = choicesCountries.getValue(); // Not passing in true as we need the label too

              this.citiesIsDisabled = country.value === '';
              this.citiesIsDisabled ? choicesCities.disable() : choicesCities.enable();

              setCities(country.value);

              return country.label;
            });

            this.$watch('city', () => {
              const city = choicesCities.getValue(); // Not passing in true as we need the label too

              this.datesIsDisabled = city.value === '';
              this.datesIsDisabled ? choicesDates.disable() : choicesDates.enable();

              setDates(city.value);

              return city.label;
            });
          })
        }
      }))
    })
  </script>
</head>
<body>
  <div
      x-data="dropdowns"
      class="dropdowns"
  >
    <select x-ref="countries"></select>
    <select x-ref="cities" :disabled="citiesIsDisabled"></select>
    <select x-ref="dates" :disabled="datesIsDisabled"></select>
  </div>
</body>
</html>
